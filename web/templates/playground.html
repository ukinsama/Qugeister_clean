<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum AI Playground - Simplified</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ - ç°¡æ˜“åŒ– */
        .sidebar-left {
            width: 200px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
        }

        .sidebar-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2a5298;
            border-bottom: 2px solid #2a5298;
            padding-bottom: 5px;
        }

        /* ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ */
        .main-visualizer {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .network-canvas {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        /* å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ - å‡ºåŠ›è¨­å®š */
        .sidebar-right {
            width: 250px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
        }

        /* SVG ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ */
        #network-svg {
            width: 100%;
            height: 100%;
        }

        /* ãƒãƒ¼ãƒ‰ï¼ˆãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³/é‡å­ãƒ“ãƒƒãƒˆï¼‰ */
        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node:hover {
            filter: brightness(1.2);
        }

        .classical-node {
            fill: #4CAF50;
            stroke: #2E7D32;
            stroke-width: 2;
        }

        .quantum-node {
            fill: #9C27B0;
            stroke: #6A1B9A;
            stroke-width: 2;
        }

        .input-node {
            fill: #2196F3;
            stroke: #1565C0;
            stroke-width: 2;
        }

        .output-node {
            fill: #FF9800;
            stroke: #E65100;
            stroke-width: 2;
        }

        /* ã‚¨ãƒƒã‚¸ï¼ˆæ¥ç¶šï¼‰ */
        .edge {
            stroke: #666;
            stroke-width: 1;
            fill: none;
            opacity: 0.6;
        }

        .quantum-edge {
            stroke: #9C27B0;
            stroke-width: 2;
            stroke-dasharray: 5,5;
            /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å‰Šé™¤ */
        }


        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .control-input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .slider {
            width: 100%;
            margin: 10px 0;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-primary:hover {
            background: #1976D2;
        }

        .btn-quantum {
            background: #9C27B0;
            color: white;
        }

        .btn-quantum:hover {
            background: #7B1FA2;
        }

        /* ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å¯è¦–åŒ– */
        .data-flow {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #FFC107;
            border-radius: 50%;
            /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å‰Šé™¤ */
            pointer-events: none;
            box-shadow: 0 0 10px #FFC107;
        }


        /* é‡å­çŠ¶æ…‹è¡¨ç¤º */
        .quantum-state {
            background: rgba(156, 39, 176, 0.1);
            border: 2px solid #9C27B0;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }

        .superposition {
            color: #9C27B0;
            font-weight: bold;
        }

        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        /* ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º */
        .metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .metric-card {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2196F3;
        }

        .metric-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡ */
        .static-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        /* ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠ */
        .layer-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 10px 0;
        }

        .layer-btn {
            padding: 5px 10px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .layer-btn.active {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }

        .layer-btn.quantum {
            border-color: #9C27B0;
        }

        .layer-btn.quantum.active {
            background: #9C27B0;
            border-color: #9C27B0;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            position: absolute;
            top: 0;
            left: 250px;
            right: 250px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5em;
            color: #2a5298;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼šé‡å­è¨­å®š -->
        <div class="sidebar-left">
            <div class="sidebar-title">âš›ï¸ é‡å­è¨­å®š</div>
            
            <div class="control-group">
                <label class="control-label">é‡å­ãƒ“ãƒƒãƒˆæ•°</label>
                <input type="range" class="slider" id="qubit-slider" 
                       min="4" max="12" value="8" 
                       oninput="updateQubits(this.value)">
                <div style="text-align: center; font-weight: bold; margin-top: 5px;">
                    <span id="qubit-count">8</span> qubits
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">é‡å­å±¤æ•°</label>
                <input type="range" class="slider" id="layer-slider" 
                       min="1" max="5" value="3" 
                       oninput="updateLayers(this.value)">
                <div style="text-align: center; font-weight: bold; margin-top: 5px;">
                    <span id="layer-count">3</span> layers
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</label>
                <select id="embedding-select" class="control-input" onchange="updateEmbedding(this.value)">
                    <option value="angle">Angle</option>
                    <option value="amplitude">Amplitude</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">ã‚¨ãƒ³ã‚¿ãƒ³ã‚°ãƒ«ãƒ¡ãƒ³ãƒˆ</label>
                <select id="entanglement-select" class="control-input" onchange="updateEntanglement(this.value)">
                    <option value="linear">Linear</option>
                    <option value="circular">Circular</option>
                    <option value="full">Full</option>
                </select>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ -->
        <div class="main-visualizer">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="header">
                <h1>ğŸŒŒ Quantum AI Playground</h1>
                <div class="subtitle">ã‚¬ã‚¤ã‚¹ã‚¿ãƒ¼é‡å­AIã®æ§‹é€ å¯è¦–åŒ– (ç°¡æ˜“ç‰ˆ)</div>
            </div>

            <!-- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æç”»ã‚¨ãƒªã‚¢ -->
            <div class="network-canvas" id="network-canvas">
                <svg id="network-svg"></svg>
                <div class="tooltip" id="tooltip"></div>
            </div>

            <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
            <div class="control-panel">
                <div class="static-controls">
                    <button class="btn btn-quantum" onclick="toggleQuantumMode()">âš›ï¸ é‡å­ãƒ¢ãƒ¼ãƒ‰</button>
                </div>
            </div>
        </div>

        <!-- å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼šé‡å­å›è·¯è©³ç´°ã¨ã‚³ãƒ³ãƒãƒ¼ã‚¶ãƒ¼é€£æº -->
        <div class="sidebar-right">
            <div class="sidebar-title">âš›ï¸ é‡å­å›è·¯è©³ç´°</div>
            
            <div class="quantum-state">
                <div style="font-weight: bold; margin-bottom: 5px;">é‡å­çŠ¶æ…‹</div>
                <div class="superposition">
                    |ÏˆâŸ© = Î±|0âŸ© + Î²|1âŸ©
                </div>
                <div style="margin-top: 10px; font-size: 0.9em;">
                    ç¢ºç‡æŒ¯å¹…: Î±=0.707, Î²=0.707
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">å›è·¯æ§‹æˆ</label>
                <div style="background: #f0f8ff; padding: 10px; border-radius: 8px; font-size: 11px; border: 1px solid #9c27b0;">
                    <div style="margin: 3px 0;"><strong>å…¥åŠ›:</strong> è§’åº¦ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</div>
                    <div style="margin: 3px 0;"><strong>ã‚²ãƒ¼ãƒˆ:</strong> RY, RZ, CNOT</div>
                    <div style="margin: 3px 0;"><strong>æ¸¬å®š:</strong> Pauli-Z</div>
                    <div style="margin: 3px 0; color: #9c27b0;"><strong>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:</strong> <span id="param-count">32</span>å€‹</div>
                </div>
            </div>
            
            <!-- ã‚³ãƒ³ãƒãƒ¼ã‚¶ãƒ¼é€£æº -->
            <div class="sidebar-title" style="margin-top: 20px; color: #9C27B0;">ğŸ”— ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</div>
            <div class="control-group">
                <button class="btn btn-quantum" style="width: 100%;" onclick="exportToQiskit()">
                    ğŸŒ IBM Quantum Composerã¸ â†’
                </button>
                <div style="font-size: 0.8em; color: #666; margin-top: 5px; text-align: center;">
                    OpenQASMã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦Composerã§å®Ÿè¡Œ
                </div>
                
                <button class="btn btn-quantum" style="width: 100%; margin-top: 10px; background: #ff6b35;" onclick="exportToQuantumDesigner()">
                    ğŸ¨ Quantum Designerã¸ â†’
                </button>
                <div style="font-size: 0.8em; color: #666; margin-top: 5px; text-align: center;">
                    è¨­å®šã¨QASMã‚³ãƒ¼ãƒ‰ã‚’Designerã§ç·¨é›†ãƒ»å­¦ç¿’
                </div>
            </div>
        </div>
    </div>

    <script>
        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹é€ ã®å®šç¾©
        let networkStructure = {
            input: 252,
            quantum: 8,
            hidden: [128, 64],
            output: 5
        };

        let isQuantumMode = true;
        let dataFlowElements = [];

        // SVGè¦ç´ ã®åˆæœŸåŒ–
        function initializeNetwork() {
            const svg = document.getElementById('network-svg');
            const rect = svg.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;

            // ã‚¯ãƒªã‚¢
            svg.innerHTML = '';

            // å±¤ã®é…ç½®
            const layers = [];
            
            // å…¥åŠ›å±¤ï¼ˆ7ãƒãƒ£ãƒ³ãƒãƒ«è¡¨ç¤ºï¼‰
            layers.push({
                type: 'input',
                nodes: 7,  // 7ãƒãƒ£ãƒ³ãƒãƒ«ã‚’è¡¨ç¤º
                x: width * 0.1,
                labels: ['è‡ªåˆ†å–„ç‰', 'è‡ªåˆ†æ‚ªç‰', 'æ•µé§’', 'ç¢ºèªæ¸ˆå–„ç‰', 'ç¢ºèªæ¸ˆæ‚ªç‰', 'åˆæ³•æ‰‹', 'è„±å‡ºä½ç½®']
            });

            // é‡å­å±¤
            if (isQuantumMode) {
                layers.push({
                    type: 'quantum',
                    nodes: networkStructure.quantum,
                    x: width * 0.35
                });
            }

            // éš ã‚Œå±¤
            layers.push({
                type: 'hidden',
                nodes: 8,  // ç°¡ç•¥åŒ–è¡¨ç¤º
                x: width * 0.6
            });

            layers.push({
                type: 'hidden',
                nodes: 6,  // ç°¡ç•¥åŒ–è¡¨ç¤º
                x: width * 0.75
            });

            // å‡ºåŠ›å±¤
            layers.push({
                type: 'output',
                nodes: 5,
                x: width * 0.9
            });

            // ãƒãƒ¼ãƒ‰ã®æç”»
            layers.forEach((layer, layerIndex) => {
                const nodeSpacing = height / (layer.nodes + 1);
                
                for (let i = 0; i < layer.nodes; i++) {
                    const y = nodeSpacing * (i + 1);
                    
                    // ãƒãƒ¼ãƒ‰ä½œæˆ
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', layer.x);
                    circle.setAttribute('cy', y);
                    circle.setAttribute('r', layer.type === 'quantum' ? 15 : 10);
                    circle.setAttribute('class', `node ${layer.type}-node`);
                    circle.setAttribute('id', `node-${layerIndex}-${i}`);
                    
                    // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
                    circle.addEventListener('mouseenter', (e) => showTooltip(e, layer, i));
                    circle.addEventListener('mouseleave', hideTooltip);
                    
                    svg.appendChild(circle);

                    // ãƒ©ãƒ™ãƒ«
                    if (layer.type === 'output') {
                        const labels = ['â†‘', 'â†’', 'â†“', 'â†', 'ğŸšª'];
                        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        text.setAttribute('x', layer.x + 25);
                        text.setAttribute('y', y + 5);
                        text.setAttribute('fill', '#333');
                        text.setAttribute('font-size', '14');
                        text.textContent = labels[i];
                        svg.appendChild(text);
                    } else if (layer.type === 'input' && layer.labels) {
                        // å…¥åŠ›å±¤ã®ãƒãƒ£ãƒ³ãƒãƒ«ãƒ©ãƒ™ãƒ«
                        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        text.setAttribute('x', layer.x - 60);
                        text.setAttribute('y', y + 5);
                        text.setAttribute('fill', '#333');
                        text.setAttribute('font-size', '10');
                        text.textContent = layer.labels[i];
                        svg.appendChild(text);
                    }
                }

                // ã‚¨ãƒƒã‚¸ã®æç”»ï¼ˆæ¬¡ã®å±¤ã¸ã®æ¥ç¶šï¼‰
                if (layerIndex < layers.length - 1) {
                    const nextLayer = layers[layerIndex + 1];
                    const currentNodeSpacing = height / (layer.nodes + 1);
                    const nextNodeSpacing = height / (nextLayer.nodes + 1);

                    // 7ãƒãƒ£ãƒ³ãƒãƒ«å‡ç­‰åˆ†æ•£ã«åŸºã¥ãæ¥ç¶šè¡¨ç¤º
                    if (layer.type === 'input' && nextLayer.type === 'quantum') {
                        // å…¥åŠ›â†’é‡å­: 7ãƒãƒ£ãƒ³ãƒãƒ«ã‹ã‚‰é‡å­ãƒ“ãƒƒãƒˆã¸ã®åˆ†æ•£ã‚’è¡¨ç¤º
                        for (let i = 0; i < layer.nodes; i++) {
                            for (let j = 0; j < nextLayer.nodes; j++) {
                            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                            const y1 = currentNodeSpacing * (i + 1);
                            const y2 = nextNodeSpacing * (j + 1);
                            
                                const d = `M ${layer.x} ${y1} Q ${(layer.x + nextLayer.x) / 2} ${(y1 + y2) / 2} ${nextLayer.x} ${y2}`;
                                path.setAttribute('d', d);
                                path.setAttribute('class', 'input-quantum-edge');
                                path.setAttribute('stroke', `hsl(${i * 360 / layer.nodes}, 70%, 50%)`);
                                path.setAttribute('stroke-width', '1.5');
                                path.setAttribute('opacity', '0.6');
                                path.setAttribute('id', `edge-${layerIndex}-${i}-${j}`);
                                
                                svg.appendChild(path);
                            }
                        }
                    } else {
                        // ãã®ä»–ã®æ¥ç¶š: ç°¡ç•¥åŒ–è¡¨ç¤º
                        for (let i = 0; i < layer.nodes; i++) {
                            for (let j = 0; j < Math.min(nextLayer.nodes, layer.nodes); j++) {
                                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                                const y1 = currentNodeSpacing * (i + 1);
                                const y2 = nextNodeSpacing * (j + 1);
                                
                                const d = `M ${layer.x} ${y1} Q ${(layer.x + nextLayer.x) / 2} ${(y1 + y2) / 2} ${nextLayer.x} ${y2}`;
                                path.setAttribute('d', d);
                                path.setAttribute('class', layer.type === 'quantum' ? 'quantum-edge' : 'edge');
                                path.setAttribute('id', `edge-${layerIndex}-${i}-${j}`);
                                
                                svg.appendChild(path);
                            }
                        }
                    }
                }
            });

            // é‡å­ã‚²ãƒ¼ãƒˆè¡¨ç¤ºï¼ˆé‡å­ãƒ¢ãƒ¼ãƒ‰æ™‚ï¼‰
            if (isQuantumMode) {
                addQuantumGates(svg, width, height);
            }
        }

        // é‡å­ã‚²ãƒ¼ãƒˆã®è¿½åŠ 
        function addQuantumGates(svg, width, height) {
            const quantumX = width * 0.35;
            const gateSize = 30;
            
            // RYã‚²ãƒ¼ãƒˆ
            const ryGate = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            ryGate.setAttribute('x', quantumX - 60);
            ryGate.setAttribute('y', height * 0.3);
            ryGate.setAttribute('width', gateSize);
            ryGate.setAttribute('height', gateSize);
            ryGate.setAttribute('fill', '#E91E63');
            ryGate.setAttribute('rx', 5);
            
            const ryText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            ryText.setAttribute('x', quantumX - 45);
            ryText.setAttribute('y', height * 0.3 + 20);
            ryText.setAttribute('fill', 'white');
            ryText.setAttribute('font-size', '12');
            ryText.setAttribute('text-anchor', 'middle');
            ryText.textContent = 'RY';
            
            svg.appendChild(ryGate);
            svg.appendChild(ryText);

            // CNOTã‚²ãƒ¼ãƒˆ
            const cnotGate = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            const cnotX = quantumX + 60;
            
            const control = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            control.setAttribute('cx', cnotX);
            control.setAttribute('cy', height * 0.4);
            control.setAttribute('r', 5);
            control.setAttribute('fill', '#3F51B5');
            
            const target = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            target.setAttribute('cx', cnotX);
            target.setAttribute('cy', height * 0.6);
            target.setAttribute('r', 8);
            target.setAttribute('fill', 'none');
            target.setAttribute('stroke', '#3F51B5');
            target.setAttribute('stroke-width', 2);
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', cnotX);
            line.setAttribute('y1', height * 0.4);
            line.setAttribute('x2', cnotX);
            line.setAttribute('y2', height * 0.6);
            line.setAttribute('stroke', '#3F51B5');
            line.setAttribute('stroke-width', 2);
            
            cnotGate.appendChild(line);
            cnotGate.appendChild(control);
            cnotGate.appendChild(target);
            svg.appendChild(cnotGate);
        }

        // å¼·åŒ–CNNå¯è¦–åŒ–åˆ¶å¾¡
        function toggleCNNVisualization(layerType) {
            const buttons = document.querySelectorAll('button[onclick*="toggleCNNVisualization"]');
            
            // Reset all buttons
            buttons.forEach(btn => {
                btn.style.backgroundColor = '';
                btn.style.color = '';
            });
            
            // Highlight selected button
            const selectedBtn = document.querySelector(`button[onclick="toggleCNNVisualization('${layerType}')"]`);
            if (selectedBtn) {
                selectedBtn.style.backgroundColor = '#4caf50';
                selectedBtn.style.color = 'white';
            }
            
            // Update visualization based on layer type
            switch(layerType) {
                case 'preprocessing':
                    visualizePreprocessingLayers();
                    break;
                case 'postprocessing':
                    visualizePostprocessingLayers();
                    break;
                case 'quantum':
                    visualizeQuantumLayers();
                    break;
                case 'gradients':
                    visualizeGradientFlow();
                    break;
            }
        }
        
        function visualizePreprocessingLayers() {
            // Simulate preprocessing layer visualization
            const svg = document.getElementById('network-svg');
            
            // Add preprocessing layer indicators
            const layers = [252, 512, 256, 128, 64, 4];
            const colors = ['#ff9800', '#ff5722', '#f44336', '#e91e63', '#9c27b0', '#673ab7'];
            
            // Clear previous indicators
            const oldIndicators = svg.querySelectorAll('.preprocessing-indicator');
            oldIndicators.forEach(ind => ind.remove());
            
            layers.forEach((size, i) => {
                const indicator = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                indicator.setAttribute('class', 'preprocessing-indicator');
                indicator.setAttribute('x', 50 + i * 70);
                indicator.setAttribute('y', 50);
                indicator.setAttribute('width', Math.min(60, size / 10));
                indicator.setAttribute('height', 20);
                indicator.setAttribute('fill', colors[i]);
                indicator.setAttribute('opacity', '0.7');
                
                // Add text label
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', 50 + i * 70 + 5);
                label.setAttribute('y', 65);
                label.setAttribute('font-size', '10');
                label.setAttribute('fill', 'white');
                label.textContent = size;
                label.setAttribute('class', 'preprocessing-indicator');
                
                svg.appendChild(indicator);
                svg.appendChild(label);
            });
        }
        
        function visualizePostprocessingLayers() {
            const svg = document.getElementById('network-svg');
            
            // Add postprocessing layer indicators
            const layers = [4, 128, 256, 512, 256, 128, 64, 36];
            const colors = ['#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a'];
            
            const oldIndicators = svg.querySelectorAll('.postprocessing-indicator');
            oldIndicators.forEach(ind => ind.remove());
            
            layers.forEach((size, i) => {
                const indicator = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                indicator.setAttribute('class', 'postprocessing-indicator');
                indicator.setAttribute('x', 50 + i * 70);
                indicator.setAttribute('y', 200);
                indicator.setAttribute('width', Math.min(60, size / 10));
                indicator.setAttribute('height', 20);
                indicator.setAttribute('fill', colors[i]);
                indicator.setAttribute('opacity', '0.7');
                
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', 50 + i * 70 + 5);
                label.setAttribute('y', 215);
                label.setAttribute('font-size', '10');
                label.setAttribute('fill', 'white');
                label.textContent = size;
                label.setAttribute('class', 'postprocessing-indicator');
                
                svg.appendChild(indicator);
                svg.appendChild(label);
            });
        }
        
        function visualizeQuantumLayers() {
            const svg = document.getElementById('network-svg');
            
            // Add quantum circuit visualization
            const oldIndicators = svg.querySelectorAll('.quantum-indicator');
            oldIndicators.forEach(ind => ind.remove());
            
            // Draw quantum circuit representation
            for (let qubit = 0; qubit < 4; qubit++) {
                // Qubit line
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('class', 'quantum-indicator');
                line.setAttribute('x1', 200);
                line.setAttribute('y1', 120 + qubit * 30);
                line.setAttribute('x2', 450);
                line.setAttribute('y2', 120 + qubit * 30);
                line.setAttribute('stroke', '#9c27b0');
                line.setAttribute('stroke-width', '2');
                svg.appendChild(line);
                
                // Quantum gates
                for (let layer = 0; layer < 2; layer++) {
                    const gate = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    gate.setAttribute('class', 'quantum-indicator');
                    gate.setAttribute('cx', 250 + layer * 80);
                    gate.setAttribute('cy', 120 + qubit * 30);
                    gate.setAttribute('r', 8);
                    gate.setAttribute('fill', '#e91e63');
                    gate.setAttribute('stroke', 'white');
                    gate.setAttribute('stroke-width', '2');
                    svg.appendChild(gate);
                }
            }
            
            // Add enhancement layer indicator
            const enhancer = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            enhancer.setAttribute('class', 'quantum-indicator');
            enhancer.setAttribute('x', 180);
            enhancer.setAttribute('y', 100);
            enhancer.setAttribute('width', 40);
            enhancer.setAttribute('height', 120);
            enhancer.setAttribute('fill', '#ff9800');
            enhancer.setAttribute('opacity', '0.3');
            enhancer.setAttribute('stroke', '#ff5722');
            enhancer.setAttribute('stroke-width', '2');
            svg.appendChild(enhancer);
            
            const enhancerLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            enhancerLabel.setAttribute('class', 'quantum-indicator');
            enhancerLabel.setAttribute('x', 200);
            enhancerLabel.setAttribute('y', 95);
            enhancerLabel.setAttribute('text-anchor', 'middle');
            enhancerLabel.setAttribute('font-size', '10');
            enhancerLabel.setAttribute('fill', '#ff5722');
            enhancerLabel.textContent = 'é‡å­ç‰¹å¾´å¢—å¼·';
            svg.appendChild(enhancerLabel);
        }
        
        function visualizeGradientFlow() {
            const svg = document.getElementById('network-svg');
            
            // Add gradient flow indicators
            const oldIndicators = svg.querySelectorAll('.gradient-indicator');
            oldIndicators.forEach(ind => ind.remove());
            
            // Simulate gradient flow with animated arrows
            for (let i = 0; i < 5; i++) {
                const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                arrow.setAttribute('class', 'gradient-indicator');
                arrow.setAttribute('d', `M ${100 + i * 100} 300 L ${150 + i * 100} 290 L ${150 + i * 100} 310 Z`);
                arrow.setAttribute('fill', '#f44336');
                arrow.setAttribute('opacity', '0.8');
                
                // é™çš„ãªçŸ¢å°ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ï¼‰
                
                svg.appendChild(arrow);
            }
            
            // Add gradient norm indicators
            const gradNorms = [2.5, 1.8, 3.2, 1.1, 2.9];
            gradNorms.forEach((norm, i) => {
                const indicator = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                indicator.setAttribute('class', 'gradient-indicator');
                indicator.setAttribute('x', 100 + i * 100);
                indicator.setAttribute('y', 330);
                indicator.setAttribute('font-size', '12');
                indicator.setAttribute('fill', '#f44336');
                indicator.textContent = `âˆ‡: ${norm}`;
                svg.appendChild(indicator);
            });
        }
        
        // Update 36D spatial Q-value map
        function updateSpatialQValueMap() {
            const cells = document.querySelectorAll('.qvalue-cell');
            
            cells.forEach(cell => {
                // Simulate dynamic Q-value updates
                const newValue = (Math.random() * 0.9 + 0.1).toFixed(1);
                cell.textContent = newValue;
                
                // Update color based on value
                const value = parseFloat(newValue);
                if (value > 0.7) {
                    cell.style.background = '#4caf50'; // High value - green
                } else if (value > 0.5) {
                    cell.style.background = '#8bc34a'; // Medium-high - light green
                } else if (value > 0.3) {
                    cell.style.background = '#cddc39'; // Medium - yellow
                } else if (value > 0.2) {
                    cell.style.background = '#ffeb3b'; // Medium-low - bright yellow
                } else {
                    cell.style.background = '#ffc107'; // Low - orange
                }
            });
        }
        
        // Performance monitoring
        function updatePerformanceMetrics() {
            // Simulate real-time performance updates
            const fps = (190 + Math.random() * 20).toFixed(1);
            const memory = (2.4 + Math.random() * 0.2).toFixed(2);
            const cacheHit = Math.floor(60 + Math.random() * 15);
            
            document.getElementById('fps-counter').textContent = fps;
            document.getElementById('memory-usage').textContent = memory;
            document.getElementById('cache-hit-rate').textContent = cacheHit;
        }
        
        // åˆå›è¡¨ç¤ºã®ã¿ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ï¼‰
        updatePerformanceMetrics();
        updateSpatialQValueMap();


        // é‡å­ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function toggleQuantumMode() {
            isQuantumMode = !isQuantumMode;
            initializeNetwork();
        }

        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤º
        function showTooltip(event, layer, nodeIndex) {
            const tooltip = document.getElementById('tooltip');
            const rect = event.target.getBoundingClientRect();
            
            let content = '';
            if (layer.type === 'input') {
                const channels = ['è‡ªåˆ†ã®å–„ç‰', 'è‡ªåˆ†ã®æ‚ªç‰', 'æ•µé§’', 'ç¢ºèªæ¸ˆã¿å–„ç‰', 'ç¢ºèªæ¸ˆã¿æ‚ªç‰', 'åˆæ³•æ‰‹', 'è„±å‡ºä½ç½®'];
                const features = ['å¹³å‡å€¤', 'æœ€å¤§å€¤', 'éã‚¼ãƒ­ç‡', 'ä¸­å¤®éƒ¨å¹³å‡'];
                content = `å…¥åŠ›ãƒãƒ£ãƒ³ãƒãƒ«: ${channels[nodeIndex]}<br>` +
                         `æ¬¡å…ƒ: 36 (6Ã—6)<br>` +
                         `æŠ½å‡ºç‰¹å¾´: ${features.join(', ')}<br>` +
                         `7ãƒãƒ£ãƒ³ãƒãƒ«Ã—4ç‰¹å¾´=28æ¬¡å…ƒ (11.1%ãƒ‡ãƒ¼ã‚¿æ´»ç”¨)<br>` +
                         `âœ… å¼·åˆ¶å‡ç­‰åˆ†æ•£: å…¨7ãƒãƒ£ãƒ³ãƒãƒ«ä¿è¨¼ (æ—§æ–¹å¼ã®4.6å€åŠ¹ç‡)`;
            } else if (layer.type === 'quantum') {
                const qubits = ['Channelæ··åˆ1', 'Channelæ··åˆ2', 'å–„ç‰ç‰¹å¾´', 'æ‚ªç‰ç‰¹å¾´', 'æ•µé§’ç‰¹å¾´', 'åˆæ³•æ‰‹ç‰¹å¾´', 'è„±å‡ºç‰¹å¾´', 'æˆ¦ç•¥ç‰¹å¾´'];
                content = `é‡å­ãƒ“ãƒƒãƒˆ ${nodeIndex + 1}: ${qubits[nodeIndex] || 'è¤‡åˆç‰¹å¾´'}<br>` +
                         `çŠ¶æ…‹: |ÏˆâŸ© = Î±|0âŸ© + Î²|1âŸ©<br>` +
                         `âœ… å¼·åˆ¶å‡ç­‰åˆ†æ•£ã«ã‚ˆã‚Šå…¨7ãƒãƒ£ãƒ³ãƒãƒ«çµ±åˆ<br>` +
                         `æ”¹å–„: ç­‰é–“éš”â†’é‡è¦åº¦é †é¸æŠ (ãƒãƒ£ãƒ³ãƒãƒ«æ¬ æè§£æ¶ˆ)`;
            } else if (layer.type === 'hidden') {
                content = `éš ã‚Œå±¤ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³<br>` +
                         `é‡å­ç‰¹å¾´ã®å¤å…¸å¤‰æ›<br>` +
                         `æ´»æ€§åŒ–: ${(Math.random() * 0.9 + 0.1).toFixed(2)}`;
            } else if (layer.type === 'output') {
                const actions = ['ä¸Šç§»å‹•', 'å³ç§»å‹•', 'ä¸‹ç§»å‹•', 'å·¦ç§»å‹•', 'è„±å‡º'];
                content = `å‡ºåŠ›: ${actions[nodeIndex]}<br>` +
                         `Qå€¤: ${(Math.random() * 0.9 + 0.1).toFixed(2)}<br>` +
                         `å…¨7ãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±ã‚’çµ±åˆã—ãŸè¡Œå‹•ä¾¡å€¤<br>` +
                         `âœ… æ”¹å–„æ¸ˆã¿: é«˜åŠ¹ç‡ãƒ‡ãƒ¼ã‚¿æ´»ç”¨ (4.6x)`;
            }
            
            tooltip.innerHTML = content;
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.top - 50) + 'px';
            tooltip.style.display = 'block';
        }

        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—éè¡¨ç¤º
        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        // å…¥åŠ›å±¤ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleInput(type) {
            event.target.classList.toggle('active');
            updateInputDim();
        }

        // å…¥åŠ›æ¬¡å…ƒã®æ›´æ–°
        function updateInputDim(value) {
            if (value) {
                const dim = value * 36;
                document.getElementById('input-dim').textContent = dim;
                document.getElementById('input-total').textContent = dim;
                document.getElementById('input-active').textContent = value;
                networkStructure.input = dim;
            }
        }

        // é‡å­ãƒ“ãƒƒãƒˆæ•°ã®æ›´æ–°
        function updateQubits(value) {
            document.getElementById('qubit-count').textContent = value;
            networkStructure.quantum = parseInt(value);
            initializeNetwork();
        }

        // é‡å­å±¤æ•°ã®æ›´æ–°
        function updateLayers(value) {
            document.getElementById('layer-count').textContent = value;
        }

        // ã‚¨ãƒ³ã‚¿ãƒ³ã‚°ãƒ«ãƒ¡ãƒ³ãƒˆã®æ›´æ–°
        function updateEntanglement(value) {
            // ã‚¨ãƒ³ã‚¿ãƒ³ã‚°ãƒ«ãƒ¡ãƒ³ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã®å¤‰æ›´
            console.log('Entanglement changed to:', value);
            initializeNetwork();
        }

        // ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®æ›´æ–°
        function updateEmbedding(value) {
            // ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ–¹å¼ã®å¤‰æ›´
            console.log('Embedding changed to:', value);
            initializeNetwork();
        }

        // è¡Œå‹•äºˆæ¸¬
        function predictAction() {
            // Qå€¤ã‹ã‚‰æœ€é©è¡Œå‹•ã‚’æ±ºå®š
            const qValues = {
                up: parseFloat(document.getElementById('q-up').textContent),
                right: parseFloat(document.getElementById('q-right').textContent),
                down: parseFloat(document.getElementById('q-down').textContent),
                left: parseFloat(document.getElementById('q-left').textContent),
                escape: parseFloat(document.getElementById('q-escape').textContent)
            };
            
            const maxAction = Object.keys(qValues).reduce((a, b) => 
                qValues[a] > qValues[b] ? a : b
            );
            
            alert(`äºˆæ¸¬è¡Œå‹•: ${maxAction === 'escape' ? 'è„±å‡º' : maxAction + 'ç§»å‹•'}\nQå€¤: ${qValues[maxAction]}`);
        }

        // åˆæœŸåŒ–
        // 3Stepè¨­å®šã®èª­ã¿è¾¼ã¿
        function load3StepConfig() {
            const configStr = localStorage.getItem('3step_config');
            if (configStr) {
                try {
                    const config = JSON.parse(configStr);
                    console.log('3Stepè¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', config);
                    
                    // è¨­å®šã‚’é©ç”¨
                    apply3StepConfig(config);
                    
                    // èª­ã¿è¾¼ã¿å®Œäº†é€šçŸ¥
                    showNotification('âœ… 3Stepè¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                    
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢ï¼ˆä¸€åº¦ã ã‘èª­ã¿è¾¼ã‚€ï¼‰
                    localStorage.removeItem('3step_config');
                    
                    return true;
                } catch (e) {
                    console.error('3Stepè¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                }
            }
            return false;
        }
        
        // 3Stepè¨­å®šã®é©ç”¨
        function apply3StepConfig(config) {
            // é‡å­ãƒ“ãƒƒãƒˆæ•°ã®è¨­å®š
            if (config.config && config.config.qubits) {
                const slider = document.getElementById('qubit-slider');
                if (slider) {
                    slider.value = config.config.qubits;
                    updateQubits(config.config.qubits);
                }
            }
            
            // å±¤æ•°ã®è¨­å®š
            if (config.config && config.config.layers) {
                const slider = document.getElementById('layer-slider');
                if (slider) {
                    slider.value = config.config.layers;
                    updateLayers(config.config.layers);
                }
            }
            
            // è¨­å®šæƒ…å ±ã‚’è¡¨ç¤º
            displayConfigInfo(config);
        }
        
        // è¨­å®šæƒ…å ±ã®è¡¨ç¤º
        function displayConfigInfo(config) {
            const infoDiv = document.createElement('div');
            infoDiv.className = 'config-info';
            infoDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(33, 150, 243, 0.95);
                color: white;
                padding: 15px;
                border-radius: 10px;
                max-width: 300px;
                z-index: 1000;
                box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            `;
            infoDiv.innerHTML = `
                <h4 style="margin: 0 0 10px 0;">ğŸ“¥ 3Stepè¨­å®šãƒ­ãƒ¼ãƒ‰å®Œäº†</h4>
                <p style="margin: 5px 0;">é…ç½®: ${config.config.placement}</p>
                <p style="margin: 5px 0;">å ±é…¬: ${config.config.reward}</p>
                <p style="margin: 5px 0;">è¡Œå‹•: ${config.config.action}</p>
                <p style="margin: 5px 0;">å­¦ç¿’: ${config.config.learningMethod}</p>
                <p style="margin: 5px 0;">é‡å­ãƒ“ãƒƒãƒˆ: ${config.config.qubits}</p>
                <p style="margin: 5px 0;">å±¤æ•°: ${config.config.layers}</p>
                <button onclick="this.parentElement.remove()" style="
                    background: white;
                    color: #2196F3;
                    border: none;
                    padding: 5px 10px;
                    border-radius: 5px;
                    cursor: pointer;
                    margin-top: 10px;
                    width: 100%;
                ">é–‰ã˜ã‚‹</button>
            `;
            document.body.appendChild(infoDiv);
            
            // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
            setTimeout(() => {
                if (infoDiv.parentElement) {
                    infoDiv.remove();
                }
            }, 5000);
        }
        
        // é€šçŸ¥è¡¨ç¤º
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                z-index: 10000;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }
        
        // IBM Quantum Composerã¸ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportToQiskit() {
            // ç¾åœ¨ã®è¨­å®šã‚’åé›†
            const n_qubits = networkStructure.quantum || 8;
            const n_layers = parseInt(document.getElementById('layer-count')?.textContent || 3);
            const entanglement = document.getElementById('entanglement-select')?.value || 'linear';
            const embedding = document.getElementById('embedding-select')?.value || 'angle';
            
            // OpenQASMã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            const qasmCode = generateOpenQASM(n_qubits, n_layers, entanglement, embedding);
            
            // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
            const encodedQASM = btoa(qasmCode);
            
            // IBM Quantum Composerã®URLã‚’æ§‹ç¯‰
            const composerURL = `https://quantum.cloud.ibm.com/composer?initial=${encodedQASM}`;
            
            // è¨­å®šæƒ…å ±ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            const configInfo = `// Quantum AI Configuration from Playground
// Generated: ${new Date().toISOString()}
// Qubits: ${n_qubits}
// Layers: ${n_layers}
// Entanglement: ${entanglement}
// Encoding: ${embedding}

${qasmCode}`;
            
            navigator.clipboard.writeText(configInfo).then(() => {
                showNotification('ğŸ“‹ OpenQASMã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            });
            
            // IBM Quantum Composerã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
            window.open(composerURL, '_blank');
            
            showNotification('ğŸš€ IBM Quantum Composerã‚’é–‹ã„ã¦ã„ã¾ã™...');
        }

        function exportToQuantumDesigner() {
            // ç¾åœ¨ã®è¨­å®šã‚’åé›†
            const n_qubits = networkStructure.quantum || 8;
            const n_layers = parseInt(document.getElementById('layer-count')?.textContent || 3);
            const entanglement = document.getElementById('entanglement-select')?.value || 'linear';
            const embedding = document.getElementById('embedding-select')?.value || 'angle';
            
            // OpenQASMã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            const qasmCode = generateOpenQASM(n_qubits, n_layers, entanglement, embedding);
            
            // è¨­å®šæƒ…å ±ã¨QASMã‚³ãƒ¼ãƒ‰ã‚’çµ±åˆ
            const fullExport = `// Quantum AI Configuration from Playground
// Generated: ${new Date().toISOString()}
// Qubits: ${n_qubits}
// Layers: ${n_layers}
// Entanglement: ${entanglement}
// Encoding: ${embedding}

${qasmCode}
`;
            
            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            navigator.clipboard.writeText(fullExport).then(() => {
                // Quantum Designerã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
                const designerParams = new URLSearchParams({
                    qubits: n_qubits,
                    layers: n_layers,
                    entanglement: entanglement,
                    source: 'playground',
                    autoload: 'true',
                    hasQasm: 'true'
                });
                
                const designerUrl = `quantum_designer.html?${designerParams.toString()}`;
                window.open(designerUrl, '_blank');
                
                showNotification('ğŸ¨ Quantum Designerã‚’é–‹ã„ã¦ã„ã¾ã™... (QASMã‚³ãƒ¼ãƒ‰ã¯ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸ)');
            }).catch(err => {
                console.error('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
                showNotification('âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }
        
        // OpenQASMã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        function generateOpenQASM(n_qubits, n_layers, entanglement, embedding = 'angle') {
            let qasm = `// Quantum AI Circuit from Playground
// Geister Game Quantum Model
OPENQASM 2.0;
include "qelib1.inc";

// ${n_qubits} qubits for quantum processing
qreg q[${n_qubits}];
creg c[${n_qubits}];

// Input encoding layer (${embedding} encoding)
`;
            
            // å…¥åŠ›ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å±¤
            if (embedding === 'amplitude') {
                // Amplitude encoding - ã‚ˆã‚Šè¤‡é›‘ãªåˆæœŸåŒ–çŠ¶æ…‹
                qasm += `// Amplitude encoding: preparing normalized state\n`;
                for (let i = 0; i < n_qubits; i++) {
                    qasm += `ry(pi/${Math.pow(2, i+1)}) q[${i}]; // Amplitude feature ${i+1}\n`;
                    qasm += `rz(pi/${Math.pow(2, i+2)}) q[${i}]; // Phase component ${i+1}\n`;
                }
            } else {
                // Angle encoding (default)
                for (let i = 0; i < n_qubits; i++) {
                    qasm += `ry(pi/4) q[${i}]; // Input feature ${i+1}\n`;
                }
            }
            
            // ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å±¤ã®å¾Œã«ãƒãƒªã‚¢
            qasm += `\nbarrier q; // Encoding layer barrier\n`;
            
            qasm += `\n// Parameterized quantum layers (${n_layers} layers)\n`;
            
            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–é‡å­å±¤
            for (let layer = 0; layer < n_layers; layer++) {
                qasm += `// Layer ${layer + 1}\n`;
                
                // å˜ä¸€é‡å­ãƒ“ãƒƒãƒˆã‚²ãƒ¼ãƒˆ
                for (let i = 0; i < n_qubits; i++) {
                    qasm += `ry(pi/8) q[${i}];\n`;
                    qasm += `rz(pi/8) q[${i}];\n`;
                }
                
                // ã‚¨ãƒ³ã‚¿ãƒ³ã‚°ãƒ«ãƒ¡ãƒ³ãƒˆ
                qasm += `// Entanglement: ${entanglement}\n`;
                if (entanglement === 'linear') {
                    for (let i = 0; i < n_qubits - 1; i++) {
                        qasm += `cx q[${i}], q[${i+1}];\n`;
                    }
                } else if (entanglement === 'circular') {
                    for (let i = 0; i < n_qubits - 1; i++) {
                        qasm += `cx q[${i}], q[${i+1}];\n`;
                    }
                    if (n_qubits > 2) {
                        qasm += `cx q[${n_qubits-1}], q[0]; // Circular connection\n`;
                    }
                } else if (entanglement === 'full') {
                    for (let i = 0; i < n_qubits; i++) {
                        for (let j = i + 1; j < n_qubits; j++) {
                            qasm += `cz q[${i}], q[${j}];\n`;
                        }
                    }
                }
                
                // å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¾Œã«ãƒãƒªã‚¢
                if (layer < n_layers - 1) {
                    qasm += `barrier q; // Layer ${layer + 1} barrier\n`;
                }
                qasm += '\n';
            }
            
            // æ¸¬å®šå‰ã®æœ€çµ‚ãƒãƒªã‚¢
            qasm += `barrier q; // Final barrier before measurement\n`;
            
            // æ¸¬å®š
            qasm += `// Measurement\n`;
            for (let i = 0; i < n_qubits; i++) {
                qasm += `measure q[${i}] -> c[${i}];\n`;
            }
            
            return qasm;
        }
        
        // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‡ãƒ¢ç”¨ã®å¯è¦–åŒ–ã‚·ã‚¹ãƒ†ãƒ 
        
        window.onload = () => {
            // 3Stepè¨­å®šãŒã‚ã‚Œã°èª­ã¿è¾¼ã‚€
            const configLoaded = load3StepConfig();
            
            // é€šå¸¸ã®åˆæœŸåŒ–
            initializeNetwork();
            
            // ã‚·ãƒ³ãƒ—ãƒ«å¯è¦–åŒ–UIè¿½åŠ 
            addRealtimeVisualizationUI();
            
            // è¨­å®šãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå ´åˆã¯å†æç”»
            if (configLoaded) {
                setTimeout(() => {
                    initializeNetwork();
                }, 100);
            }
        };

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯è¦–åŒ–UIè¿½åŠ 
        function addRealtimeVisualizationUI() {
            // å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ¶å¾¡ãƒ‘ãƒãƒ«ã‚’è¿½åŠ 
            const rightSidebar = document.querySelector('.sidebar-right');
            if (!rightSidebar) return;
            
            const realtimePanel = document.createElement('div');
            realtimePanel.className = 'realtime-panel';
            realtimePanel.innerHTML = `
                <div class="sidebar-title">ğŸ”¬ CQCNNæ§‹é€ åˆ¶å¾¡</div>
                
                <!-- ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æƒ…å ± -->
                <div class="architecture-section">
                    <h4>ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£</h4>
                    <div class="arch-item">
                        <span>å‰å‡¦ç†CNN:</span>
                        <span class="arch-value">252â†’512â†’256â†’128â†’64â†’4</span>
                    </div>
                    <div class="arch-item">
                        <span>é‡å­å›è·¯:</span>
                        <span class="arch-value">4é‡å­ãƒ“ãƒƒãƒˆ, 2å±¤</span>
                    </div>
                    <div class="arch-item">
                        <span>å¾Œå‡¦ç†CNN:</span>
                        <span class="arch-value">4â†’128â†’256â†’512â†’256â†’128â†’64â†’36</span>
                    </div>
                    <div class="arch-item">
                        <span>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:</span>
                        <span class="arch-value">647,044å€‹</span>
                    </div>
                </div>
                
                <!-- å±¤è¡¨ç¤ºåˆ¶å¾¡ -->
                <div class="layer-control-section">
                    <h4>ğŸ›ï¸ å±¤è¡¨ç¤ºåˆ¶å¾¡</h4>
                    <div class="layer-toggles">
                        <label><input type="checkbox" id="showPreprocessor" checked onchange="toggleLayer('preprocessor')"> å‰å‡¦ç†CNN</label>
                        <label><input type="checkbox" id="showQuantum" checked onchange="toggleLayer('quantum')"> é‡å­å›è·¯</label>
                        <label><input type="checkbox" id="showPostprocessor" checked onchange="toggleLayer('postprocessor')"> å¾Œå‡¦ç†CNN</label>
                        <label><input type="checkbox" id="showConnections" checked onchange="toggleLayer('connections')"> æ¥ç¶šç·š</label>
                    </div>
                </div>
                
                <!-- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ“ä½œ -->
                <div class="network-control-section">
                    <h4>ğŸ”§ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ“ä½œ</h4>
                    <button onclick="highlightDataFlow()" class="control-btn">ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å¼·èª¿è¡¨ç¤º</button>
                    <button onclick="showLayerDetails()" class="control-btn">å±¤è©³ç´°è¡¨ç¤º</button>
                    <button onclick="showForwardPass()" class="control-btn">é †ä¼æ’­ãƒ‘ã‚¹è¡¨ç¤º</button>
                    <button onclick="resetVisualization()" class="control-btn secondary">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
                
                <!-- é‡å­å›è·¯è©³ç´° -->
                <div class="quantum-details-section">
                    <h4>âš›ï¸ é‡å­å›è·¯è©³ç´°</h4>
                    <div class="quantum-info">
                        <div class="qubit-count">é‡å­ãƒ“ãƒƒãƒˆæ•°: <span id="qubitCount">4</span></div>
                        <div class="gate-count">ã‚²ãƒ¼ãƒˆæ•°: <span id="gateCount">16</span></div>
                        <div class="entanglement-type">ã‚¨ãƒ³ã‚¿ãƒ³ã‚°ãƒ«ãƒ¡ãƒ³ãƒˆ: <span id="entanglementType">Linear</span></div>
                    </div>
                    <button onclick="showQuantumCircuit()" class="control-btn quantum">å›è·¯å›³è¡¨ç¤º</button>
                </div>
            `;
            
            rightSidebar.appendChild(realtimePanel);
            
            // CSSè¿½åŠ 
            addRealtimeCSS();
        }
        
        function addRealtimeCSS() {
            const style = document.createElement('style');
            style.textContent = `
                .realtime-panel {
                    margin-top: 20px;
                    border-top: 2px solid #2a5298;
                    padding-top: 15px;
                }
                
                .architecture-section, .layer-control-section, .network-control-section, .quantum-details-section {
                    margin-bottom: 15px;
                    padding: 12px;
                    background-color: rgba(0,0,0,0.05);
                    border-radius: 8px;
                    border-left: 3px solid #2a5298;
                }
                
                .architecture-section h4, .layer-control-section h4, .network-control-section h4, .quantum-details-section h4 {
                    margin: 0 0 10px 0;
                    font-size: 0.9em;
                    color: #2a5298;
                    font-weight: bold;
                }
                
                .arch-item {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 6px;
                    font-size: 0.8em;
                    align-items: center;
                }
                
                .arch-value {
                    font-family: 'Courier New', monospace;
                    font-weight: bold;
                    color: #1565c0;
                    background: rgba(33, 150, 243, 0.1);
                    padding: 2px 6px;
                    border-radius: 3px;
                    font-size: 0.75em;
                }
                
                .layer-toggles {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }
                
                .layer-toggles label {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    font-size: 0.8em;
                    cursor: pointer;
                    padding: 4px;
                    border-radius: 4px;
                    transition: background-color 0.2s;
                }
                
                .layer-toggles label:hover {
                    background-color: rgba(42, 82, 152, 0.1);
                }
                
                .layer-toggles input[type="checkbox"] {
                    transform: scale(1.2);
                }
                
                .control-btn {
                    width: 100%;
                    padding: 8px 10px;
                    margin: 3px 0;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 0.8em;
                    font-weight: bold;
                    transition: all 0.2s ease;
                }
                
                .control-btn {
                    background-color: #2196f3;
                    color: white;
                }
                
                .control-btn:hover {
                    background-color: #1976d2;
                    transform: translateY(-1px);
                }
                
                .control-btn.secondary {
                    background-color: #666;
                }
                
                .control-btn.secondary:hover {
                    background-color: #555;
                }
                
                .control-btn.quantum {
                    background-color: #9c27b0;
                }
                
                .control-btn.quantum:hover {
                    background-color: #7b1fa2;
                }
                
                .quantum-info {
                    margin-bottom: 10px;
                }
                
                .quantum-info > div {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 4px;
                    font-size: 0.8em;
                }
                
                .quantum-info span {
                    font-weight: bold;
                    color: #9c27b0;
                }
                
                /* ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¯è¦–åŒ–å¼·åŒ–ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
                .layer-highlighted {
                    stroke: #ff5722 !important;
                    stroke-width: 3 !important;
                    filter: drop-shadow(0 0 8px #ff5722);
                }
                
                .node-highlighted {
                    fill: #ff5722 !important;
                    stroke: #d84315 !important;
                    stroke-width: 3 !important;
                    filter: drop-shadow(0 0 6px #ff5722);
                    transform: scale(1.2);
                }
                
                .connection-highlighted {
                    stroke: #4caf50 !important;
                    stroke-width: 4 !important;
                    stroke-dasharray: 10,5;
                    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å‰Šé™¤ */
                }
                
                
                .layer-hidden {
                    opacity: 0.1;
                    pointer-events: none;
                }
                
                .quantum-circuit-popup {
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: 20px;
                    border-radius: 12px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    z-index: 1000;
                    max-width: 600px;
                    max-height: 400px;
                    overflow: auto;
                }
                
                .popup-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 999;
                }
            `;
            document.head.appendChild(style);
        }
        
        // CQCNNæ§‹é€ å¯è¦–åŒ–ã¨æ“ä½œæ©Ÿèƒ½
        let currentHighlight = null;
        
        function toggleLayer(layerType) {
            console.log(`Toggling layer: ${layerType}`);
            const checkbox = document.getElementById(`show${layerType.charAt(0).toUpperCase() + layerType.slice(1)}`);
            const isVisible = checkbox.checked;
            
            // SVGå†…ã®è©²å½“ã™ã‚‹è¦ç´ ã‚’å–å¾—
            const nodes = document.querySelectorAll(`.${layerType}-node, .${layerType}`);
            const connections = document.querySelectorAll(`.${layerType}-connection`);
            
            if (isVisible) {
                // è¡¨ç¤º
                nodes.forEach(node => node.classList.remove('layer-hidden'));
                connections.forEach(conn => conn.classList.remove('layer-hidden'));
            } else {
                // éè¡¨ç¤º
                nodes.forEach(node => node.classList.add('layer-hidden'));
                connections.forEach(conn => conn.classList.add('layer-hidden'));
            }
            
            // ç‰¹åˆ¥å‡¦ç†: é‡å­ãƒãƒ¼ãƒ‰
            if (layerType === 'quantum') {
                const quantumNodes = document.querySelectorAll('.quantum-node');
                quantumNodes.forEach(node => {
                    if (isVisible) {
                        node.classList.remove('layer-hidden');
                    } else {
                        node.classList.add('layer-hidden');
                    }
                });
            }
        }
        
        function highlightDataFlow() {
            console.log('Highlighting data flow');
            resetVisualization();
            
            const inputNodes = document.querySelectorAll('.input-node');
            const quantumNodes = document.querySelectorAll('.quantum-node');
            const outputNodes = document.querySelectorAll('.output-node');
            const connections = document.querySelectorAll('line[stroke="rgba(100,100,100,0.6)"]');
            
            // æ®µéšçš„ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            setTimeout(() => {
                inputNodes.forEach(node => node.classList.add('node-highlighted'));
            }, 0);
            
            setTimeout(() => {
                connections.forEach((conn, index) => {
                    setTimeout(() => {
                        conn.classList.add('connection-highlighted');
                    }, index * 50);
                });
            }, 500);
            
            setTimeout(() => {
                quantumNodes.forEach(node => node.classList.add('node-highlighted'));
            }, 1000);
            
            setTimeout(() => {
                outputNodes.forEach(node => node.classList.add('node-highlighted'));
            }, 1500);
            
            currentHighlight = 'dataflow';
        }
        
        function showLayerDetails() {
            const layerInfo = {
                'Preprocessor CNN': {
                    layers: ['Input(252)', 'Dense(512)', 'LayerNorm', 'ReLU', 'Dropout(0.2)', 'Dense(256)', 'LayerNorm', 'ReLU', 'Dropout(0.2)', 'Dense(128)', 'LayerNorm', 'ReLU', 'Dropout(0.1)', 'Dense(64)', 'LayerNorm', 'ReLU', 'Dropout(0.1)', 'Dense(4)'],
                    parameters: '331,844'
                },
                'Quantum Circuit': {
                    layers: ['Input Encoding', 'Variational Layers(2)', 'Measurement'],
                    parameters: '32'
                },
                'Postprocessor CNN': {
                    layers: ['Dense(128)', 'LayerNorm', 'ReLU', 'Dropout(0.1)', 'Dense(256)', 'LayerNorm', 'ReLU', 'Dropout(0.2)', 'Dense(512)', 'LayerNorm', 'ReLU', 'Dropout(0.2)', 'Dense(256)', 'LayerNorm', 'ReLU', 'Dropout(0.2)', 'Dense(128)', 'LayerNorm', 'ReLU', 'Dropout(0.1)', 'Dense(64)', 'LayerNorm', 'ReLU', 'Dense(36)'],
                    parameters: '315,168'
                }
            };
            
            let details = '<h3>ğŸ” CQCNN å±¤è©³ç´°æƒ…å ±</h3>';
            Object.keys(layerInfo).forEach(layer => {
                details += `<div style="margin: 15px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">`;
                details += `<h4 style="color: #2a5298; margin: 0 0 8px 0;">${layer}</h4>`;
                details += `<div style="font-size: 0.8em; margin-bottom: 5px;"><strong>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°:</strong> ${layerInfo[layer].parameters}</div>`;
                details += `<div style="font-size: 0.8em;"><strong>æ§‹é€ :</strong> ${layerInfo[layer].layers.join(' â†’ ')}</div>`;
                details += '</div>';
            });
            
            showPopup(details);
        }
        
        function showForwardPass() {
            console.log('Showing forward pass path');
            resetVisualization();
            
            // é™çš„ã«ã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º
            const steps = ['.input-node', '.classical-node', '.quantum-node', '.output-node'];
            steps.forEach(selector => {
                const nodes = document.querySelectorAll(selector);
                nodes.forEach(node => {
                    node.classList.add('node-highlighted');
                });
            });
        }
        
        function resetVisualization() {
            console.log('Resetting visualization');
            const highlightedElements = document.querySelectorAll('.node-highlighted, .connection-highlighted, .layer-highlighted');
            highlightedElements.forEach(el => {
                el.classList.remove('node-highlighted', 'connection-highlighted', 'layer-highlighted');
                el.style.transition = '';
            });
            
            closePopup();
            currentHighlight = null;
        }
        
        function showQuantumCircuit() {
            const quantumInfo = document.getElementById('entanglementType').textContent;
            const qubits = document.getElementById('qubitCount').textContent;
            const gates = document.getElementById('gateCount').textContent;
            
            const circuitHtml = `
                <h3>âš›ï¸ é‡å­å›è·¯å›³</h3>
                <div style="margin: 20px 0;">
                    <div style="font-family: monospace; background: #f5f5f5; padding: 15px; border-radius: 5px;">
                        <div>é‡å­ãƒ“ãƒƒãƒˆæ•°: ${qubits}</div>
                        <div>ã‚²ãƒ¼ãƒˆæ•°: ${gates}</div>
                        <div>ã‚¨ãƒ³ã‚¿ãƒ³ã‚°ãƒ«ãƒ¡ãƒ³ãƒˆ: ${quantumInfo}</div>
                    </div>
                </div>
                <div style="text-align: center; margin: 20px 0;">
                    <div style="font-family: monospace; font-size: 0.9em; line-height: 1.6;">
                        <div>q[0] â”€|0âŸ©â”€ RY(Î¸â‚) â”€ RZ(Ï†â‚) â”€ â—â”€â”€â”€â”€â”€â”€â”€ RY(Î¸â‚…) â”€ RZ(Ï†â‚…) â”€ M</div>
                        <div>q[1] â”€|0âŸ©â”€ RY(Î¸â‚‚) â”€ RZ(Ï†â‚‚) â”€ âŠ•â”€ â—â”€â”€â”€ RY(Î¸â‚†) â”€ RZ(Ï†â‚†) â”€ M</div>
                        <div>q[2] â”€|0âŸ©â”€ RY(Î¸â‚ƒ) â”€ RZ(Ï†â‚ƒ) â”€â”€â”€â”€â”€ âŠ•â”€ â—â”€ RY(Î¸â‚‡) â”€ RZ(Ï†â‚‡) â”€ M</div>
                        <div>q[3] â”€|0âŸ©â”€ RY(Î¸â‚„) â”€ RZ(Ï†â‚„) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ âŠ• RY(Î¸â‚ˆ) â”€ RZ(Ï†â‚ˆ) â”€ M</div>
                    </div>
                    <div style="margin-top: 15px; font-size: 0.8em; color: #666;">
                        â— = Control, âŠ• = Target, RY/RZ = Rotation Gates, M = Measurement
                    </div>
                </div>
                <button onclick="closePopup()" style="padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">é–‰ã˜ã‚‹</button>
            `;
            
            showPopup(circuitHtml);
        }
        
        function showPopup(content) {
            closePopup(); // æ—¢å­˜ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
            
            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay';
            overlay.onclick = closePopup;
            
            const popup = document.createElement('div');
            popup.className = 'quantum-circuit-popup';
            popup.innerHTML = content;
            
            document.body.appendChild(overlay);
            document.body.appendChild(popup);
        }
        
        function closePopup() {
            const overlay = document.querySelector('.popup-overlay');
            const popup = document.querySelector('.quantum-circuit-popup');
            if (overlay) overlay.remove();
            if (popup) popup.remove();
        }
        
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
        window.onresize = () => {
            initializeNetwork();
        };
        
        // ãƒšãƒ¼ã‚¸ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã®æ¸…ç†ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆã§ã¯ä¸è¦ï¼‰
    </script>
</body>
</html>